<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title></title>
<style>
  /* ç”»é¢ã«ã¯è³ªå•æ–‡ä»¥å¤–ã®UIã‚’å‡ºã•ãªã„ã€‚å€™è£œåã¯ãƒ†ã‚­ã‚¹ãƒˆé¢¨ãƒœã‚¿ãƒ³ã«ã—ã¦ã‚¯ãƒªãƒƒã‚¯æŠ•ç¥¨ã€‚ */
  html, body { margin:0; padding:0; background:#fff; color:#111; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  .qwrap { max-width: 900px; margin: 20px auto; padding: 0 12px; }
  .question { font-size: clamp(18px, 2.4vw, 24px); line-height: 1.8; margin: 0; }
  .name-btn {
    appearance: none;
    border: none;
    background: transparent;
    padding: 0 4px;
    margin: 0 2px;
    font: inherit;
    cursor: pointer;
    border-radius: 8px;
  }
  .name-btn strong { font-weight: 700; }
  .name-btn:hover { background: #f8fafc; outline: 1px solid #e5e7eb; }
  .name-btn:disabled { cursor: not-allowed; opacity: .5; outline: none; }
</style>
</head>
<body>
  <!-- ç”»é¢ã«è¦‹ãˆã‚‹ã®ã¯ã“ã®ä¸€æ–‡ã ã‘ -->
  <div class="qwrap">
    <p class="question" aria-live="polite">
      <button class="name-btn" id="btn-left" title="å·¦ã«æŠ•ç¥¨">
        <strong id="label-left">â€”</strong>
      </button>
      ã¨
      <button class="name-btn" id="btn-right" title="å³ã«æŠ•ç¥¨">
        <strong id="label-right">â€”</strong>
      </button>
      ã€ã©ã¡ã‚‰ãŒå¥½ãã§ã™ã‹ï¼Ÿ
    </p>
  </div>

<script type="module">
/* ===== Firebase v12.4.0ï¼ˆå¤‰æ›´ä¸å¯ï¼‰ ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  runTransaction, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCRHvaE9WMODFhDau9sgqs11lzkW6wrFbc",
  authDomain: "project-617841149941118768.firebaseapp.com",
  projectId: "project-617841149941118768",
  storageBucket: "project-617841149941118768.firebasestorage.app",
  messagingSenderId: "699664731293",
  appId: "1:699664731293:web:0ab38c64fb6fc023049874"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ===== å›ºå®šå€™è£œï¼ˆã‚µã‚¤ãƒˆã‹ã‚‰å¤‰æ›´ä¸å¯ï¼‰ ===== */
const OPTIONS = [
  "ğŸ Apple","ğŸŠ Orange","ğŸ‡ Grape","ğŸ‘ Peach",
  "ğŸ‰ Watermelon","ğŸŒ Banana","ğŸ Pineapple","ğŸ“ Strawberry",
  "ğŸ¥­ Mango","ğŸˆ Melon","ğŸ¥ Kiwi"
];

/* ===== èª¿æ•´ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆ1ç¥¨å…ˆå–ï¼‰ ===== */
const TOURNAMENT_DOC_ID = "main";
const VOTE_THRESHOLD    = 1;

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
function shuffle(arr){
  const a = arr.slice();
  for (let i=a.length-1; i>0; i--){
    const j = crypto.getRandomValues(new Uint32Array(1))[0] % (i+1);
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function buildMatches(participants){
  const p = shuffle(participants);
  const m = [];
  let id = 1;
  for (let i=0; i<p.length; i+=2){
    m.push({ id:id++, left:p[i] ?? null, right:p[i+1] ?? null, winner:null, leftCount:0, rightCount:0 });
  }
  return m;
}
function allResolved(matches){ return matches.every(x => x.winner !== null); }

/* ===== åˆæœŸåŒ– ===== */
async function initTournamentIfNeeded(){
  const ref = doc(db, "tournaments", TOURNAMENT_DOC_ID);
  const snap = await getDoc(ref);
  if (snap.exists()) return;
  const matches = buildMatches(OPTIONS);
  const nextCandidates = [];
  for (const m of matches){
    if (m.left && !m.right){ m.winner = m.left;  nextCandidates.push(m.left); }
    else if (!m.left && m.right){ m.winner = m.right; nextCandidates.push(m.right); }
  }
  await setDoc(ref, {
    round: 1, matchIndex: 0, matches, nextCandidates,
    champion: null,
    threshold: VOTE_THRESHOLD,
    updatedAt: serverTimestamp()
  });
}

/* ===== ãƒ©ã‚¦ãƒ³ãƒ‰é·ç§» ===== */
async function startNextRound(docData){
  const ref = doc(db, "tournaments", TOURNAMENT_DOC_ID);
  const winners = (docData.nextCandidates ?? []).slice();
  if (winners.length === 0) return; // å®‰å…¨ç­–

  if (winners.length === 1){
    // æ±ºç€ â†’ UI ã§ã¯è¡¨ç¤ºã›ãšå³å†åˆæœŸåŒ–ã•ã›ã‚‹ï¼ˆonSnapshot å´ã§å¯¾å¿œï¼‰
    await updateDoc(ref, { champion: winners[0], updatedAt: serverTimestamp() });
    return;
  }
  const matches = buildMatches(winners);
  const nextCandidates = [];
  for (const m of matches){
    if (m.left && !m.right){ m.winner = m.left; nextCandidates.push(m.left); }
    else if (!m.left && m.right){ m.winner = m.right; nextCandidates.push(m.right); }
  }
  await updateDoc(ref, {
    round: (docData.round ?? 1) + 1,
    matchIndex: 0,
    matches,
    nextCandidates,
    updatedAt: serverTimestamp()
  });
}

/* ===== æŠ•ç¥¨ ===== */
async function vote(side){
  const ref = doc(db, "tournaments", TOURNAMENT_DOC_ID);
  await runTransaction(db, async (tx) => {
    const snap = await tx.get(ref);
    if (!snap.exists()) throw "not-found";
    const d = snap.data();
    if (d.champion) return;

    const idx = d.matchIndex ?? 0;
    const matches = d.matches ?? [];
    const m = matches[idx];
    if (!m || m.winner) return;
    if (!m.left || !m.right) return;

    if (side === 'left') m.leftCount = (m.leftCount ?? 0) + 1;
    else m.rightCount = (m.rightCount ?? 0) + 1;

    const threshold = d.threshold ?? VOTE_THRESHOLD;
    if ((m.leftCount ?? 0) >= threshold || (m.rightCount ?? 0) >= threshold){
      m.winner = (m.leftCount >= m.rightCount) ? m.left : m.right;
      const next = (d.nextCandidates ?? []).slice();
      next.push(m.winner);

      let matchIndex = (d.matchIndex ?? 0) + 1;
      while (matchIndex < matches.length && matches[matchIndex].winner) matchIndex++;

      tx.update(ref, { matches, nextCandidates: next, matchIndex, updatedAt: serverTimestamp() });

      // æ—¢å­˜ã®å³æ™‚ãƒã‚§ãƒƒã‚¯ï¼ˆæ®‹ã™ï¼‰
      setTimeout(async () => {
        const after = (await getDoc(ref)).data();
        if (after && allResolved(after.matches)) await startNextRound(after);
      }, 0);
    } else {
      tx.update(ref, { matches, updatedAt: serverTimestamp() });
    }
  });
}

/* ===== UIï¼ˆè³ªå•æ–‡ã ã‘ï¼‰ ===== */
const $ = (id)=>document.getElementById(id);
$("btn-left").addEventListener("click", () => vote('left'));
$("btn-right").addEventListener("click", () => vote('right'));

/* ===== å†…éƒ¨å†åˆæœŸåŒ–ï¼ˆå„ªå‹æ™‚ã«è‡ªå‹•ã§ä¸€å›æˆ¦ã¸ï¼‰ ===== */
async function reinitTournament(){
  const ref = doc(db, "tournaments", TOURNAMENT_DOC_ID);
  const matches = buildMatches(OPTIONS);
  const nextCandidates = [];
  for (const m of matches){
    if (m.left && !m.right){ m.winner = m.left; nextCandidates.push(m.left); }
    else if (!m.left && m.right){ m.winner = m.right; nextCandidates.push(m.right); }
  }
  await setDoc(ref, {
    round: 1, matchIndex: 0, matches, nextCandidates,
    champion: null,
    threshold: VOTE_THRESHOLD,
    updatedAt: serverTimestamp()
  });
}

/* ===== çŠ¶æ…‹ç›£è¦–ï¼ˆç”»é¢ã«æ–‡å­—ã¯å‡ºã•ãªã„ï¼‰ ===== */
let resetting = false;      // å„ªå‹â†’è‡ªå‹•å†åˆæœŸåŒ–ã®äºŒé‡é˜²æ­¢
let advancingRound = false; // ãƒ©ã‚¦ãƒ³ãƒ‰å³æ™‚é·ç§»ã®äºŒé‡é˜²æ­¢

onSnapshot(doc(db, "tournaments", TOURNAMENT_DOC_ID), (snap) => {
  const d = snap.data();
  if (!d) return;

  // å„ªå‹ãŒæ±ºã¾ã£ãŸã‚‰ç”»é¢ã«ã€Œå„ªå‹ã€ç­‰ã¯ä¸€åˆ‡å‡ºã•ãšå³å†åˆæœŸåŒ–
  if (d.champion && !resetting){
    resetting = true;
    reinitTournament().finally(()=>{ resetting = false; });
    return;
  }

  // ãƒ©ã‚¦ãƒ³ãƒ‰ãŒå…¨è©¦åˆçµ‚äº†ã—ãŸã‚‰ã™ãæ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ç”Ÿæˆ
  if (!d.champion && Array.isArray(d.matches) && d.matches.length > 0 && allResolved(d.matches) && !advancingRound){
    advancingRound = true;
    startNextRound(d).finally(()=>{ advancingRound = false; });
    return;
  }

  const idx = d.matchIndex ?? 0;
  const match = d.matches?.[idx];

  // ãƒ©ã‚¦ãƒ³ãƒ‰ã®ç‹­é–“ï¼ˆ!matchï¼‰ã§å–ã‚Šã“ã¼ã—ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  if (!match){
    if (!d.champion && Array.isArray(d.matches) && (allResolved(d.matches) || idx >= d.matches.length) && !advancingRound){
      advancingRound = true;
      startNextRound(d).finally(()=>{ advancingRound = false; });
    }
    // ä½•ã‚‚è¡¨ç¤ºã—ãªã„ã®ã§ return
    return;
  }

  // è¡¨ç¤ºã™ã‚‹ã®ã¯å€™è£œåã®ã¿ï¼ˆè³ªå•æ–‡å†…ï¼‰
  $("label-left").textContent  = match.left  ?? "â€”";
  $("label-right").textContent = match.right ?? "â€”";

  const playable = !!(match.left && match.right && !match.winner);
  $("btn-left").disabled  = !playable;
  $("btn-right").disabled = !playable;
});

/* ===== èµ·å‹•ï¼šåˆæœŸåŒ– ===== */
initTournamentIfNeeded();
</script>
</body>
</html>
