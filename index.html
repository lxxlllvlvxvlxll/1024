<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é€æ˜ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆï¼ˆèª°ã§ã‚‚ã™ãæŠ•ç¥¨ãƒ»ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰</title>
<style>
  :root { --w: 900px; --fg:#111; --muted:#6b7280; --bd:#e5e7eb; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; color:var(--fg); }
  header { border-bottom:1px solid var(--bd); }
  .wrap { max-width: var(--w); margin: 0 auto; padding: 16px; }
  h1 { font-size: 20px; margin: 0 0 6px; }
  .muted { color: var(--muted); }
  .card { border:1px solid var(--bd); border-radius:16px; padding:16px; margin:12px 0; }
  .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  button.choice { width:100%; border:1px solid var(--bd); border-radius:14px; padding:18px; font-size:18px; background:#fff; cursor:pointer; }
  button.choice:hover { border-color:#cbd5e1; box-shadow:0 2px 10px rgba(0,0,0,.04); }
  .badge { display:inline-block; border:1px solid var(--bd); border-radius:999px; padding:3px 10px; font-size:12px; color:var(--muted); }
  .row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .votes { font-variant-numeric: tabular-nums; }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>é€æ˜ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ</h1>
    <div class="muted">2æŠã ã‘ãƒ»è¨­å®šä¸å¯ãƒ»å„ãƒ©ã‚¦ãƒ³ãƒ‰ ãƒ©ãƒ³ãƒ€ãƒ çµ„åˆã›ãƒ»BYEè‡ªå‹•ãƒ»ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ</div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="badge" id="badge-round">Round -</div>
      <div class="muted">è©¦åˆ: <span id="badge-match">-</span></div>
    </div>
    <h2 style="margin-top:8px">ã©ã¡ã‚‰ã«æŠ•ç¥¨ã—ã¾ã™ã‹ï¼Ÿ</h2>

    <div class="grid2" style="margin-top:8px">
      <button class="choice" id="btn-left">
        <strong id="label-left">å·¦</strong>
        <div class="muted votes">ç¥¨æ•°: <span id="count-left">0</span></div>
      </button>
      <button class="choice" id="btn-right">
        <strong id="label-right">å³</strong>
        <div class="muted votes">ç¥¨æ•°: <span id="count-right">0</span></div>
      </button>
    </div>

    <div class="row" style="margin-top:10px; justify-content:space-between;">
      <div class="muted" id="info-line"></div>
      <button id="btn-reset" title="æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
    <p id="status" class="muted" style="margin:8px 0 0;"></p>
  </section>
</main>

<!-- Firebase CDNï¼ˆv10 modularï¼‰ -->
<script type="module">
/* ========= ã“ã“ã ã‘ç½®ãæ›ãˆ ========= */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
/* =================================== */

/* ======== å›ºå®šã®é¸æŠè‚¢ï¼ˆã‚µã‚¤ãƒˆã‹ã‚‰å¤‰æ›´ä¸å¯ï¼‰ ======== */
const OPTIONS = [
  "ğŸ Apple","ğŸŠ Orange","ğŸ‡ Grape","ğŸ‘ Peach",
  "ğŸ‰ Watermelon","ğŸŒ Banana","ğŸ Pineapple","ğŸ“ Strawberry",
  "ğŸ¥­ Mango","ğŸˆ Melon","ğŸ¥ Kiwi"
];

/* ======== è¨­å®šï¼ˆã‚³ãƒ¼ãƒ‰å†…ã®ã¿å¤‰æ›´ï¼‰ ======== */
const TOURNAMENT_DOC_ID = "main";     // Firestore ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID
const VOTE_THRESHOLD = 25;            // å…ˆå–ç¥¨æ•°ï¼ˆä¾‹ï¼š25ç¥¨ï¼‰

/* ======== ä»¥é™ã¯è§¦ã‚‰ãªãã¦OK ======== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, runTransaction, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- ä¹±æŠãƒ»BYEãƒ»çµ„åˆã› ---------- */
function shuffle(arr){
  const a = arr.slice();
  for (let i=a.length-1; i>0; i--){
    const j = crypto.getRandomValues(new Uint32Array(1))[0] % (i+1);
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function buildMatches(participants){
  const p = shuffle(participants);
  const m = [];
  let id = 1;
  for (let i=0; i<p.length; i+=2){
    m.push({ id:id++, left:p[i] ?? null, right:p[i+1] ?? null, winner:null, leftCount:0, rightCount:0 });
  }
  return m;
}
function allResolved(matches){ return matches.every(m => m.winner !== null); }

/* ---------- Firestore ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å½¢ ---------- */
/*
tournaments/main = {
  round: number,
  matchIndex: number,
  matches: [ {id,left,right,winner,leftCount,rightCount} ],
  nextCandidates: string[],
  champion: string|null,
  optionsHash: string,
  threshold: number,
  updatedAt: serverTimestamp()
}
*/

/* ---------- åˆæœŸåŒ–ï¼ˆèª°ã‹ãŒæœ€åˆã«1å›ã‚„ã‚Œã°OKï¼‰ ---------- */
async function initTournamentIfNeeded() {
  const ref = doc(db, "tournaments", TOURNAMENT_DOC_ID);
  const snap = await getDoc(ref);
  if (snap.exists()) return;

  const matches = buildMatches(OPTIONS);
  const nextCandidates = [];
  for (const m of matches){
    if (m.left && !m.right) { m.winner = m.left; nextCandidates.push(m.left); }
    else if (!m.left && m.right) { m.winner = m.right; nextCandidates.push(m.right); }
  }
  await setDoc(ref, {
    round: 1, matchIndex: 0, matches, nextCandidates,
    champion: null,
    optionsHash: await sha256(JSON.stringify(OPTIONS)),
    threshold: VOTE_THRESHOLD,
    updatedAt: serverTimestamp()
  });
}

/* ---------- ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†â†’æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹ ---------- */
async function startNextRound(currDoc) {
  const ref = doc(db, "tournaments", TOURNAMENT_DOC_ID);
  const winners = currDoc.nextCandidates.slice();
  if (winners.length === 1){
    await updateDoc(ref, { champion: winners[0], updatedAt: serverTimestamp() });
    return;
  }
  const matches = buildMatches(winners);
  const nextCandidates = [];
  for (const m of matches){
    if (m.left && !m.right) { m.winner = m.left; nextCandidates.push(m.left); }
    else if (!m.left && m.right) { m.winner = m.right; nextCandidates.push(m.right); }
  }
  await updateDoc(ref, {
    round: (currDoc.round ?? 1) + 1,
    matchIndex: 0,
    matches,
    nextCandidates,
    updatedAt: serverTimestamp()
  });
}

/* ---------- æŠ•ç¥¨ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ï¼å…¬é–‹æ›¸ãè¾¼ã¿æƒ³å®šï¼‰ ---------- */
async function vote(side /* 'left'|'right' */){
  const ref = doc(db, "tournaments", TOURNAMENT_DOC_ID);
  await runTransaction(db, async (tx) => {
    const snap = await tx.get(ref);
    if (!snap.exists()) throw "not-found";
    const data = snap.data();
    if (data.champion) return;

    const idx = data.matchIndex ?? 0;
    const matches = data.matches ?? [];
    const m = matches[idx];
    if (!m || m.winner) return;
    if (!m.left || !m.right) return;

    if (side === 'left') m.leftCount = (m.leftCount ?? 0) + 1;
    else m.rightCount = (m.rightCount ?? 0) + 1;

    const threshold = data.threshold ?? VOTE_THRESHOLD;
    if ((m.leftCount ?? 0) >= threshold || (m.rightCount ?? 0) >= threshold){
      m.winner = (m.leftCount >= m.rightCount) ? m.left : m.right;
      const next = (data.nextCandidates ?? []).slice();
      next.push(m.winner);

      let matchIndex = (data.matchIndex ?? 0) + 1;
      while (matchIndex < matches.length && matches[matchIndex].winner) matchIndex++;

      tx.update(ref, { matches, nextCandidates: next, matchIndex, updatedAt: serverTimestamp() });

      // å…¨è©¦åˆç¢ºå®šãªã‚‰æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰ã¸
      setTimeout(async () => {
        const after = (await getDoc(ref)).data();
        if (after && allResolved(after.matches)) await startNextRound(after);
      }, 0);
    } else {
      tx.update(ref, { matches, updatedAt: serverTimestamp() });
    }
  });
}

/* ---------- UIãƒã‚¤ãƒ³ãƒ‰ ---------- */
const $ = (id)=>document.getElementById(id);
$("btn-left").addEventListener("click", () => vote('left'));
$("btn-right").addEventListener("click", () => vote('right'));
$("btn-reset").addEventListener("click", async ()=>{
  if (!confirm("ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
  const ref = doc(db, "tournaments", TOURNAMENT_DOC_ID);
  const matches = buildMatches(OPTIONS);
  const nextCandidates = [];
  for (const m of matches){
    if (m.left && !m.right) { m.winner = m.left; nextCandidates.push(m.left); }
    else if (!m.left && m.right) { m.winner = m.right; nextCandidates.push(m.right); }
  }
  await setDoc(ref, {
    round: 1, matchIndex: 0, matches, nextCandidates,
    champion: null,
    optionsHash: await sha256(JSON.stringify(OPTIONS)),
    threshold: VOTE_THRESHOLD,
    updatedAt: serverTimestamp()
  });
});

/* ---------- è¡¨ç¤ºã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–° ---------- */
onSnapshot(doc(db, "tournaments", TOURNAMENT_DOC_ID), (snap) => {
  const d = snap.data();
  if (!d){ $("status").textContent = "åˆæœŸåŒ–ä¸­â€¦"; return; }
  $("badge-round").textContent = d.champion ? "æ±ºç€" : `Round ${d.round ?? 1}`;

  if (d.champion){
    $("badge-match").textContent = "-";
    $("label-left").textContent = `ğŸ‰ å„ªå‹ï¼š${d.champion}`;
    $("label-right").textContent = "ãƒªã‚»ãƒƒãƒˆã§å†é–‹";
    $("count-left").textContent = "â€”";
    $("count-right").textContent = "â€”";
    $("btn-left").disabled = true;
    $("btn-right").disabled = true;
    $("status").textContent = "ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆçµ‚äº†ã€‚";
    $("info-line").textContent = `å›ºå®šå€™è£œ ${OPTIONS.length} ä»¶ï¼ˆã—ãã„å€¤ ${d.threshold} ç¥¨ï¼‰`;
    return;
  }

  const idx = d.matchIndex ?? 0;
  let match = d.matches?.[idx];
  $("info-line").textContent = `å›ºå®šå€™è£œ ${OPTIONS.length} ä»¶ï¼ˆã—ãã„å€¤ ${d.threshold} ç¥¨ï¼‰`;

  if (!match){
    $("badge-match").textContent = "-";
    $("label-left").textContent = "â€¦";
    $("label-right").textContent = "â€¦";
    $("count-left").textContent = "0";
    $("count-right").textContent = "0";
    $("btn-left").disabled = $("btn-right").disabled = true;
    $("status").textContent = "æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰ã¸é€²è¡Œä¸­â€¦";
    return;
  }

  $("badge-match").textContent = String(match.id);
  $("label-left").textContent = match.left ?? "TBD";
  $("label-right").textContent = match.right ?? "TBD";
  $("count-left").textContent = match.leftCount ?? 0;
  $("count-right").textContent = match.rightCount ?? 0;

  const playable = !!(match.left && match.right && !match.winner);
  $("btn-left").disabled = $("btn-right").disabled = !playable;
  $("status").textContent = playable
    ? `ã“ã®è©¦åˆã¯å…ˆå– ${d.threshold} ç¥¨ã§æ±ºç€ã—ã¾ã™ã€‚`
    : `å‰ã®è©¦åˆãŒç‰‡ä»˜ãã¨è‡ªå‹•ã§é€²ã¿ã¾ã™ï¼ˆBYEã¯è‡ªå‹•å‡¦ç†ï¼‰ã€‚`;
});

/* ---------- èµ·å‹•ï¼šåˆæœŸåŒ–ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ï¼‰ ---------- */
initTournamentIfNeeded();

/* ---------- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼šSHA-256 ---------- */
async function sha256(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
</script>
</body>
</html>
